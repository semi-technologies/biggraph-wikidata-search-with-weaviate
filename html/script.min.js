var weaviate_gql=weaviate_url+"/v1/graphql",wikidata_url="https://query.wikidata.org/sparql?query=";function xml2json(e,t){var n={toObj:function(e){var t={};if(1==e.nodeType){if(e.attributes.length)for(var a=0;a<e.attributes.length;a++)t["@"+e.attributes[a].nodeName]=(e.attributes[a].nodeValue||"").toString();if(e.firstChild){for(var r=0,i=0,l=!1,o=e.firstChild;o;o=o.nextSibling)1==o.nodeType?l=!0:3==o.nodeType&&o.nodeValue.match(/[^ \f\n\r\t\v]/)?r++:4==o.nodeType&&i++;if(l)if(r<2&&i<2){n.removeWhite(e);for(o=e.firstChild;o;o=o.nextSibling)3==o.nodeType?t["#text"]=n.escape(o.nodeValue):4==o.nodeType?t["#cdata"]=n.escape(o.nodeValue):t[o.nodeName]?t[o.nodeName]instanceof Array?t[o.nodeName][t[o.nodeName].length]=n.toObj(o):t[o.nodeName]=[t[o.nodeName],n.toObj(o)]:t[o.nodeName]=n.toObj(o)}else e.attributes.length?t["#text"]=n.escape(n.innerXml(e)):t=n.escape(n.innerXml(e));else if(r)e.attributes.length?t["#text"]=n.escape(n.innerXml(e)):t=n.escape(n.innerXml(e));else if(i)if(i>1)t=n.escape(n.innerXml(e));else for(o=e.firstChild;o;o=o.nextSibling)t["#cdata"]=n.escape(o.nodeValue)}e.attributes.length||e.firstChild||(t=null)}else 9==e.nodeType?t=n.toObj(e.documentElement):alert("unhandled node type: "+e.nodeType);return t},toJson:function(e,t,a){var r=t?'"'+t+'"':"";if(e instanceof Array){for(var i=0,l=e.length;i<l;i++)e[i]=n.toJson(e[i],"",a+"\t");r+=(t?":[":"[")+(e.length>1?"\n"+a+"\t"+e.join(",\n"+a+"\t")+"\n"+a:e.join(""))+"]"}else if(null==e)r+=(t&&":")+"null";else if("object"==typeof e){var o=[];for(var d in e)o[o.length]=n.toJson(e[d],d,a+"\t");r+=(t?":{":"{")+(o.length>1?"\n"+a+"\t"+o.join(",\n"+a+"\t")+"\n"+a:o.join(""))+"}"}else r+="string"==typeof e?(t&&":")+'"'+e.toString()+'"':(t&&":")+e.toString();return r},innerXml:function(e){var t="";if("innerHTML"in e)t=e.innerHTML;else for(var n=function(e){var t="";if(1==e.nodeType){t+="<"+e.nodeName;for(var a=0;a<e.attributes.length;a++)t+=" "+e.attributes[a].nodeName+'="'+(e.attributes[a].nodeValue||"").toString()+'"';if(e.firstChild){t+=">";for(var r=e.firstChild;r;r=r.nextSibling)t+=n(r);t+="</"+e.nodeName+">"}else t+="/>"}else 3==e.nodeType?t+=e.nodeValue:4==e.nodeType&&(t+="<![CDATA["+e.nodeValue+"]]>");return t},a=e.firstChild;a;a=a.nextSibling)t+=n(a);return t},escape:function(e){return e.replace(/[\\]/g,"\\\\").replace(/[\"]/g,'\\"').replace(/[\n]/g,"\\n").replace(/[\r]/g,"\\r")},removeWhite:function(e){e.normalize();for(var t=e.firstChild;t;)if(3==t.nodeType)if(t.nodeValue.match(/[^ \f\n\r\t\v]/))t=t.nextSibling;else{var a=t.nextSibling;e.removeChild(t),t=a}else 1==t.nodeType?(n.removeWhite(t),t=t.nextSibling):t=t.nextSibling;return e}};9==e.nodeType&&(e=e.documentElement);var a=n.toJson(n.toObj(n.removeWhite(e)),e.nodeName,"\t");return"{\n"+t+(t?a.replace(/\t/g,t):a.replace(/\t|\n/g,""))+"\n}"}function sortObj(e){return Object.keys(e).sort().reduce(function(t,n){return t[n]=e[n],t},{})}var showContent=function(e,t){var n=[],a=0;$(".nn-result").not("#first-result").remove(),$.each(e,function(t){n.push(e[t].certainty)}),n=n.sort(function(e,t){return t-e}),$.each(n,function(r){$.each(e,function(i){if(e[i].certainty===n[r]){var l=100*e[i].certainty,o=$("#first-result").clone();o.removeAttr("id"),o.find("h3").text(e[i].label),o.find("small").html('<a href="'+i+'" target="_blank">'+getEntityId(i).substring(3)+"</a>"),o.find(".bd-placeholder-img").css("background-image","url('"+e[i].image+"')"),""==e[i].image?o.find(".bd-placeholder-img").css("background-image","url('https://upload.wikimedia.org/wikipedia/commons/6/65/No-Image-Placeholder.svg')"):o.find(".bd-placeholder-img").css("background-image","url('"+e[i].image+"')"),o.find(".progress-bar").css("width",l+"%"),o.find(".progress-bar").attr("aria-valuenow",l),o.find(".progress-bar").text("certainty: "+Math.round(100*l)/100+"%"),o.find(".btn-gql").attr("href","http://console.semi.technology/console/query#weaviate_uri="+weaviate_url+"&graphql_query="+encodeURIComponent(t.query)+"&prettify=1"),o.find(".btn-nn").click(function(e){doSearch(getEntityId(i).substring(3)),e.preventDefault}),o.appendTo(".row"),o.delay(a).fadeIn("slow"),a+=50}})})},makeEntryGraphqlQuery=function(e){return{query:'{ Get { Entity( where: { path: ["url"] operator: Equal valueString: "http://www.wikidata.org/entity/'+e+'" } limit: 1 ) { url _additional { id } } } }',variables:null}},makeSimilarityGraphqlQuery=function(e){return{query:'{ Get { Entity( nearObject: { id: "'+e+'" certainty: 0.75 } limit: 24) { url _additional { id certainty } } Label( nearObject: { id: "'+e+'" certainty: 0.8 } ) { content language _additional { id certainty } } } }',variables:null}},makeEntrySparqlQuery=function(e){return e=e.replaceAll(">_reverse_relatio",""),encodeURIComponent("SELECT ?item ?itemLabel ?class ?classLabel ?projectLabel WHERE {\n VALUES ?item { "+e+' }\n OPTIONAL { \n ?item wdt:P31 ?class;\n wdt:P18 ?project.\n } \n SERVICE wikibase:label { bd:serviceParam wikibase:language "en,en". } }')},getGraphql=function(e,t){$.ajax({type:"POST",dataType:"json",contentType:"application/json;charset=utf-8",url:weaviate_gql,data:JSON.stringify(e),success:function(e){t(e)}})},getSparql=function(e,t){$.get(wikidata_url+e,function(e){t(e)}).fail(function(){showNullResults()})},getEntityId=function(e){var t=e.split("/");return"wd:"+t[t.length-1]},getFromSparqlResult=function(e,t){switch(e){case"image":for(let e=0;e<t.binding.length;e++)if("projectLabel"==t.binding[e]["@name"])return t.binding[e].literal;return"";case"label":for(let e=0;e<t.binding.length;e++)if("itemLabel"==t.binding[e]["@name"])return t.binding[e].literal["#text"];return"";case"entity":for(let e=0;e<t.binding.length;e++)if("item"==t.binding[e]["@name"])return t.binding[e].uri;return"";default:return""}},parseXML=function(e){var t={},n=JSON.parse(xml2json(e,""));return $(n.sparql.results.result).each(function(){var e=getFromSparqlResult("entity",this),n=getFromSparqlResult("image",this),a=getFromSparqlResult("label",this);t[e]={label:a,image:n}}),t},addDistance=function(e,t){var n=t.data.Get.Entity;for(let t=0;t<n.length;t++)void 0!==e[n[t].url]&&(e[n[t].url].certainty=n[t]._additional.certainty);return e},showResults=function(e){$(e.data.Get.Entity).each(function(){var e=makeSimilarityGraphqlQuery(this._additional.id);handleLoader("Do a similarity match in Weaviate"),getGraphql(e,function(t){var n="";$(t.data.Get.Entity).each(function(){n+=getEntityId(this.url)+" "});var a=makeEntrySparqlQuery(n);handleLoader("Find meta-data and images from Wikidata"),getSparql(a,function(n){var a=parseXML(n),r=addDistance(a,t);showContent(r,e),$("#loader").hide()})})})},showNullResults=function(){$("#loader").hide(),$(".404").show()},doSearch=function(e){var t=makeEntryGraphqlQuery(e);$("#search-bar").val(e),$(".404").hide(),$(".nn-result").hide(),handleLoader("Find the vector position for this ID in Weaviate"),getGraphql(t,function(e){0===e.data.Get.Entity.length?showNullResults():showResults(e)})};function handleLoader(e){$("#loader").show(),$("#loader").find(".loader-info").text(e)}$(document).ready(function(){$("#loader").hide(),$("#exec-search").click(function(e){doSearch($("#search-bar").val()),e.preventDefault()}),$("#search-bar").keypress(function(e){13==e.which&&(e.preventDefault(),doSearch($("#search-bar").val()))})});