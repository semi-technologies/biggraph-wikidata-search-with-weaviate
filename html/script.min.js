var weaviate_gql=weaviate_url+"/v1/graphql",wikidata_url="https://query.wikidata.org/sparql?query=";function xml2json(e,t){var n={toObj:function(e){var t={};if(1==e.nodeType){if(e.attributes.length)for(var r=0;r<e.attributes.length;r++)t["@"+e.attributes[r].nodeName]=(e.attributes[r].nodeValue||"").toString();if(e.firstChild){for(var i=0,a=0,l=!1,o=e.firstChild;o;o=o.nextSibling)1==o.nodeType?l=!0:3==o.nodeType&&o.nodeValue.match(/[^ \f\n\r\t\v]/)?i++:4==o.nodeType&&a++;if(l)if(i<2&&a<2){n.removeWhite(e);for(o=e.firstChild;o;o=o.nextSibling)3==o.nodeType?t["#text"]=n.escape(o.nodeValue):4==o.nodeType?t["#cdata"]=n.escape(o.nodeValue):t[o.nodeName]?t[o.nodeName]instanceof Array?t[o.nodeName][t[o.nodeName].length]=n.toObj(o):t[o.nodeName]=[t[o.nodeName],n.toObj(o)]:t[o.nodeName]=n.toObj(o)}else e.attributes.length?t["#text"]=n.escape(n.innerXml(e)):t=n.escape(n.innerXml(e));else if(i)e.attributes.length?t["#text"]=n.escape(n.innerXml(e)):t=n.escape(n.innerXml(e));else if(a)if(a>1)t=n.escape(n.innerXml(e));else for(o=e.firstChild;o;o=o.nextSibling)t["#cdata"]=n.escape(o.nodeValue)}e.attributes.length||e.firstChild||(t=null)}else 9==e.nodeType?t=n.toObj(e.documentElement):alert("unhandled node type: "+e.nodeType);return t},toJson:function(e,t,r){var i=t?'"'+t+'"':"";if(e instanceof Array){for(var a=0,l=e.length;a<l;a++)e[a]=n.toJson(e[a],"",r+"\t");i+=(t?":[":"[")+(e.length>1?"\n"+r+"\t"+e.join(",\n"+r+"\t")+"\n"+r:e.join(""))+"]"}else if(null==e)i+=(t&&":")+"null";else if("object"==typeof e){var o=[];for(var u in e)o[o.length]=n.toJson(e[u],u,r+"\t");i+=(t?":{":"{")+(o.length>1?"\n"+r+"\t"+o.join(",\n"+r+"\t")+"\n"+r:o.join(""))+"}"}else i+="string"==typeof e?(t&&":")+'"'+e.toString()+'"':(t&&":")+e.toString();return i},innerXml:function(e){var t="";if("innerHTML"in e)t=e.innerHTML;else for(var n=function(e){var t="";if(1==e.nodeType){t+="<"+e.nodeName;for(var r=0;r<e.attributes.length;r++)t+=" "+e.attributes[r].nodeName+'="'+(e.attributes[r].nodeValue||"").toString()+'"';if(e.firstChild){t+=">";for(var i=e.firstChild;i;i=i.nextSibling)t+=n(i);t+="</"+e.nodeName+">"}else t+="/>"}else 3==e.nodeType?t+=e.nodeValue:4==e.nodeType&&(t+="<![CDATA["+e.nodeValue+"]]>");return t},r=e.firstChild;r;r=r.nextSibling)t+=n(r);return t},escape:function(e){return e.replace(/[\\]/g,"\\\\").replace(/[\"]/g,'\\"').replace(/[\n]/g,"\\n").replace(/[\r]/g,"\\r")},removeWhite:function(e){e.normalize();for(var t=e.firstChild;t;)if(3==t.nodeType)if(t.nodeValue.match(/[^ \f\n\r\t\v]/))t=t.nextSibling;else{var r=t.nextSibling;e.removeChild(t),t=r}else 1==t.nodeType?(n.removeWhite(t),t=t.nextSibling):t=t.nextSibling;return e}};9==e.nodeType&&(e=e.documentElement);var r=n.toJson(n.toObj(n.removeWhite(e)),e.nodeName,"\t");return"{\n"+t+(t?r.replace(/\t/g,t):r.replace(/\t|\n/g,""))+"\n}"}function sortObj(e){return Object.keys(e).sort().reduce(function(t,n){return t[n]=e[n],t},{})}var showContent=function(e,t){var n=[],r=0;$(".nn-result").not("#first-result").remove(),$.each(e,function(t){n.push(e[t].certainty)}),n=n.sort(function(e,t){return t-e}),$.each(n,function(i){$.each(e,function(a){if(e[a].certainty===n[i]){var l=100*e[a].certainty,o=$("#first-result").clone();o.removeAttr("id"),o.find("h3").text(e[a].label),o.find("small").html('<a href="'+a+'" target="_blank">'+getEntityId(a).substring(3)+"</a>"),o.find(".bd-placeholder-img").css("background-image","url('"+e[a].image+"')"),o.find(".progress-bar").css("width",l+"%"),o.find(".progress-bar").attr("aria-valuenow",l),o.find(".progress-bar").text("certainty: "+Math.round(100*l)/100+"%"),o.find(".btn-gql").attr("href","http://console.semi.technology/console/query#weaviate_uri="+weaviate_url+"&graphql_query="+encodeURIComponent(t.query)+"&prettify=1"),o.find(".btn-nn").click(function(e){doSearch(getEntityId(a).substring(3)),e.preventDefault}),o.appendTo(".row"),o.delay(r).fadeIn("slow"),r+=50}})})},makeEntryGraphqlQuery=function(e){return{query:'{ Get { Entity( where: { path: ["url"] operator: Equal valueString: "http://www.wikidata.org/entity/'+e+'" } limit: 1 ) { url _additional { id } } } }',variables:null}},makeSimilarityGraphqlQuery=function(e){return{query:'{ Get { Entity( nearObject: { id: "'+e+'" certainty: 0.75 } limit: 24) { url _additional { id certainty } } Label( nearObject: { id: "'+e+'" certainty: 0.8 } ) { content language _additional { id certainty } } } }',variables:null}},makeEntrySparqlQuery=function(e){return encodeURIComponent("SELECT ?item ?itemLabel ?class ?classLabel ?projectLabel WHERE {\n VALUES ?item { "+e+' }\n ?item wdt:P31 ?class;\n wdt:P18 ?project.\n SERVICE wikibase:label { bd:serviceParam wikibase:language "en,en". } }')},getGraphql=function(e,t){$.ajax({type:"POST",dataType:"json",contentType:"application/json;charset=utf-8",url:weaviate_gql,data:JSON.stringify(e),success:function(e){t(e)}})},getSparql=function(e,t){$.get(wikidata_url+e,function(e){t(e)})},getEntityId=function(e){var t=e.split("/");return"wd:"+t[t.length-1]},getFromSparqlResult=function(e,t){switch(e){case"image":for(let e=0;e<t.binding.length;e++)if("projectLabel"==t.binding[e]["@name"])return t.binding[e].literal;return"";case"label":for(let e=0;e<t.binding.length;e++)if("itemLabel"==t.binding[e]["@name"])return t.binding[e].literal["#text"];return"";case"entity":for(let e=0;e<t.binding.length;e++)if("item"==t.binding[e]["@name"])return t.binding[e].uri;return"";default:return""}},parseXML=function(e){var t={},n=JSON.parse(xml2json(e,""));return $(n.sparql.results.result).each(function(){var e=getFromSparqlResult("entity",this),n=getFromSparqlResult("image",this),r=getFromSparqlResult("label",this);t[e]={label:r,image:n}}),t},addDistance=function(e,t){var n=t.data.Get.Entity;for(let t=0;t<n.length;t++)void 0!==e[n[t].url]&&(e[n[t].url].certainty=n[t]._additional.certainty);return e},showResults=function(e){$(e.data.Get.Entity).each(function(){var e=makeSimilarityGraphqlQuery(this._additional.id);getGraphql(e,function(t){var n="";$(t.data.Get.Entity).each(function(){n+=getEntityId(this.url)+" "});var r=makeEntrySparqlQuery(n);getSparql(r,function(n){var r=parseXML(n),i=addDistance(r,t);showContent(i,e)})})})},showNullResults=function(){$(".404").show()},doSearch=function(e){var t=makeEntryGraphqlQuery(e);$("#search-bar").val(e),$(".404").hide(),$(".nn-result").hide(),getGraphql(t,function(e){0===e.data.Get.Entity.length?showNullResults():showResults(e)})};$(document).ready(function(){$("#exec-search").click(function(e){doSearch($("#search-bar").val()),e.preventDefault()}),$("#search-bar").keypress(function(e){13==e.which&&(e.preventDefault(),doSearch($("#search-bar").val()))})});